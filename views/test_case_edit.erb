<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="utf-8">
		<meta http-equiv="X-UA-Compatible" content="IE=edge">
		<meta name="viewport" content="width=device-width, initial-scale=1.0">
		<title>Edit Test Case</title>
		<!-- Custom CSS Settings -->
		<link href="/css/E2E_Custom.css" rel="stylesheet">
		<link href="/css/bootstrap.min.css" rel="stylesheet">
		<link href="/css/flat-ui.css" rel="stylesheet">		
		<link href="/css/demo.css" rel="stylesheet">
		<link href="/css/user-dropdown.css" rel="stylesheet">

		<!-- Bootstrap Theme -->
		<link href="/css/bootstrap-theme.css" rel="stylesheet">

		<!-- jQuery -->
		<script src="/js/jquery-2.0.2.min.js"></script>

		<!-- Bootstrap Core -->
		<script src="/js/bootstrap.min.js"></script>

		<!-- Bootstrap Core -->
		<link href="/css/bootstrap-dialog.min.css" rel="stylesheet" type="text/css" />
		<script src="/js/bootstrap-dialog.min.js"></script>

		<!-- DataTables plugin -->
		<link rel="stylesheet" type="text/css" href="/css/dataTables.bootstrap.css">
		<script type="text/javascript" language="javascript" src="/js/jquery.dataTables.min.js"></script>
		<script type="text/javascript" language="javascript" src="/js/dataTables.bootstrap.js"></script>

		<!-- Validation rules for the 2 tables on the page -->
		<script type="text/javascript" language="javascript" src="/js/test.cases/testcase.field.validation.js"></script>
		<script type="text/javascript" language="javascript" src="/js/test.cases/testcase.save.validation.js"></script>

		<!-- Definition of the 2 tables and related functions -->
		<script type="text/javascript" language="javascript" src="/js/test.cases/data.tables.flows.js"></script>
		<script type="text/javascript" language="javascript" src="/js/test.cases/data.tables.steps.js"></script>

		<!-- Ladda spinning button animations -->
		<link rel="stylesheet" href="/css/ladda-themeless.min.css">
		<script src="/js/spin.min.js"></script>
		<script src="/js/ladda.min.js"></script>	
		
		<style type="text/css">

			html {
		        /* Size of largest container or bigger */
		        min-width: 1280px;
		    }

			/*.btn{width:100px; height:40px; margin-top:10px; cursor:pointer;}*/
			.has-feedback .form-control-feedback {
			    position: absolute;
			    top: 0px;
			    right: 15px;
			    display: block;
			    width: 34px;
			    height: 34px;
			    line-height: 34px;
			    text-align: center;
			}

			td {word-wrap: break-word;} 

			input[type="radio"]{width: 30px; padding: 15px; margin: 13px 0};}
		</style>
	</head>

	<script type="text/javascript">
		var gTestHeader = {};
		var gTestDetail = {};
		var gTestSteps = {};

		// Hack for IE cache problem; for some reason IE caches all ajax
		$.ajaxSetup({ cache: false });

		$(function(){
			// 保存表格的原始数据 By:Sara
			gTestHeader = getHeaderData("#header");
			gTestDetail = getDetailData("#flows");
			gTestSteps = getStepData("#steps");

			//Set the radio buttons based on DB values
		    var $radio_tc = $('input:radio[name=test_case_type]');
		    var $radios_exec = $('input:radio[name=exec_type]');
			var tc_id;
			var curFlow;

		    if($radio_tc.is(':checked') == false || $radios_exec.is(':checked') == false) {
		    	<%@testcase.each do |items|%>
		    		tc_id = <%=items.id%>;
		        	$radio_tc.filter('[value=<%=items.test_case_type%>]').prop('checked', true);
		        	$radios_exec.filter('[value=<%=items.exec_type%>]').prop('checked', true);
		        <%end%>
		    }

			// IE Hack to allow validation of cell lengths
			$('body').on('focus', '[contenteditable]', function() {
			    var $this = $(this);
			    $this.data('before', $this.html());
			    return $this;
			}).on('blur keyup paste input', '[contenteditable]', function() {
			    var $this = $(this);
			    if ($this.data('before') !== $this.html()) {
			        $this.data('before', $this.html());
			        $this.trigger('change');
			        $this.trigger('input');
			    }
			    return $this;
			});	

			$('#infoFlow').on('click', 'li', function(){
		        // Mark the selection & set the value in the flow table
		        $(this).addClass("active").siblings().removeClass("active");
		        //$(temp).val(this.id);

		        var data = this.id;
		        var arr = data.split(':');

		        curFlow = arr[0];
		    })

		    $('#infoFlow').on('dblclick', 'li', function(){
		    	var row;
		    	var tabFlows = $('#flows').dataTable();
		    	var tabSteps = $('#steps').dataTable();

		    	// Mark the selection & set the value in the flow table
		        $(this).addClass("active").siblings().removeClass("active");

		        var data = this.id;
		        var arr = data.split(':');

		        curFlow = arr[0];

		        // Get the parts of this flow and create rows in the flow table
		        var url = "/submitFlowID/flow_id=" + curFlow
			    $.getJSON(url,function(data){
			    	// Delete all current rows
			    	var curFlows = tabFlows.fnGetNodes();
			    	if (tabSteps.fnGetData().length > 0) { 
			    		confirmDeleteFlows(data); 
			    	} else {
						// Delete all current rows
						tabFlows.fnClearTable();
									    		
				    	// Loop and create rows
				        $.each(data,function(i, item){
							$('#addFlowRow').trigger('click');

							// Look up the app id in the app table to get the data
							$.getJSON("/getapp/"+item.app_id,function(dataA){
								//alert(dataA[0].app_name);
								//.find('#app_id');

						        var arrN = tabFlows.fnGetNodes();
						        var lastRow = arrN[i];

								// Enter the product info
								$(lastRow).find('td').eq(3).html(dataA[0].project_id + " - " + dataA[0].app_name + "<button type='button' id='search_product' class='btn btn-info btn-xs pull-right' style='margin:2px;'>Search</button>");
								// Enter the app id
								$(lastRow).find('td').eq(10).text(dataA[0].id);

								// Enable the Add button
								$(lastRow).find('td').eq(9).find('#addStepRow').removeClass('disabled');
							})
				        })
				        // Close the dialog
	                    $('#clear_flow').trigger('click');
			    	}

			    })
		    })

		    $('#select_flow').click(function(){
		    	var row;
		    	var tabFlows = $('#flows').dataTable();
				var tabSteps = $('#steps').dataTable();

		        // Get the parts of this flow and create rows in the flow table
		        var url = "/submitFlowID/flow_id=" + curFlow
			    $.getJSON(url,function(data){
			    	// Delete all current rows
			    	var curFlows = tabFlows.fnGetNodes();
			    	if (tabSteps.fnGetData().length > 0) { 
			    		confirmDeleteFlows(data); 
			    	} else {
						// Delete all current rows
						tabFlows.fnClearTable();

				    	// Loop and create rows
				        $.each(data,function(i, item){
							$('#addFlowRow').trigger('click');

							// Look up the app id in the app table to get the data
							$.getJSON("/getapp/"+item.app_id,function(dataA){
								//alert(dataA[0].app_name);
								//.find('#app_id');

						        var arrN = tabFlows.fnGetNodes();
						        var lastRow = arrN[i];

								// Enter the product info
								$(lastRow).find('td').eq(3).html(dataA[0].project_id + " - " + dataA[0].app_name + "<button type='button' id='search_product' class='btn btn-info btn-xs pull-right' style='margin:2px;'>Search</button>");
								// Enter the app id
								$(lastRow).find('td').eq(10).text(dataA[0].id);

								// Enable the Add button
								$(lastRow).find('td').eq(9).find('#addStepRow').removeClass('disabled');
							})
				        })
				        // Close the dialog
	                    $('#clear_flow').trigger('click');
			    	}

			    })
		    })    

			//trigger submit data
			$('#submit_data').on('click',function(){			
				updateStepTableDOM();

				var bigdata = {big_data:[]}
				var testHeaderID = getTestCaseID(tc_id)
				var testHeader = getHeaderData("#header")
				var testDetail = getDetailData("#flows", true)
				var testSteps = getStepData("#steps", true)
				// console.log(testHeader)
				// console.log(testDetail)
				// console.log(testSteps)

				bigdata.big_data.push(testHeaderID)
				bigdata.big_data.push(testHeader)
				bigdata.big_data.push(testDetail)
				bigdata.big_data.push(testSteps)

				// Test Case Validation
				//flowNameCheck(function ( result ) {
					//console.log("Result: ", result);
					//if (result == false) {
						// Validate solo cases
						//soloNameCheck(function ( result2 ) {
							//console.log("Result2: ", result2);
							//if (result2 == "") {
								//Check for required fields
								var failFields = "";
								arrFail = checkRequiredFields();
								if (arrFail.length > 0){
									failFields = '\nTEST CASE HEADER: \n\nFields [';
									for ( var i = 0; i < arrFail.length; i = i + 1 ) {
									    failFields += arrFail[i] + ', ';
									}
									failFields = failFields.substr(0, failFields.length - 2) + "]";					
								}

								var failFlowFields = "";
								arrFailFlow = checkRequiredFlowFields();
								if (arrFailFlow.length > 0){
									failFlowFields = '\n\nTEST CASE APPLICATION FLOW: Rows [';
									for ( var i = 0; i < arrFailFlow.length; i = i + 1 ) {
									    failFlowFields += arrFailFlow[i] + ', ';
									}
									failFlowFields = failFlowFields.substr(0, failFlowFields.length - 2) + "]";					
								}

								var failStepFields = "";
								arrFailStep = checkRequiredStepFields();
								if (arrFailStep.length > 0){
									failStepFields = '\n\nSOLO CASE STEPS:';
									for ( var i = 0; i < arrFailStep.length; i = i + 1 ) {
									    failStepFields += arrFailStep[i] ;
									}
									//failStepFields = failStepFields.substr(0, failStepFields.length - 2) + "]";					
								}

								// Check that the flow contains at least 2 elements
								var tabFlows = $('#flows').dataTable();
								var failFlowLength = "";
								var rowCount = $('#flows tr').length;
								var rows = $('#flows tr');
								if (tabFlows.fnGetNodes().length == 1 ) {
									failFlowLength = "Flows must contain at least 2 Products!"
								}

								if (arrFail.length == 0 && arrFailFlow.length == 0 && arrFailStep.length == 0 && failFlowLength.length == 0){
							    	$.ajax({
							            type: "POST",
							            url: "/docreateheader",
							            data: bigdata,
							            success: function(data){
								        	BootstrapDialog.show({
								        		type: BootstrapDialog.TYPE_INFO,
												title: 'Test Case Data Created', 
												message: 'All Test Case Data was saved successfully!',
									            buttons: [{
									                label: 'Close',
									                cssClass: 'btn-info',
									                action: function(dialogItself){
									                    dialogItself.close();
									                }
									            }],
												onhidden: function(dialogRef){
													$('#submit_data').attr('disabled', false);	
													Ladda.stopAll();								
													window.location.assign('/test_case_edit/'+data.replace(/\"/g, ""));
								        		}
									        });

							            },
						                error: function (xhr, ajaxOptions, thrownError) {
						                	//throw the ruby exception error message --- Joseph
						                	var error_type=xhr.responseText.split("Ruby Error")[1];
						            		var error_message=xhr.responseText.split("Ruby Error")[2];
						            		var error_location=xhr.responseText.split("Ruby Error")[3];
						            		//HTML to show the error location in the textarea
						            		var details="<head><b>Details:</b></head><div><textarea readonly="+"readonly"+" rows="+"6"+" cols="+"60"+" style=resize:"+"none"+">"+error_location+"</textarea></div>";
						            		BootstrapDialog.show({
							        			type: BootstrapDialog.TYPE_DANGER,
												title: 'Save Error',
												message: "<b>Error Type: </b>" + error_type + "<br><b>Error message: </b>"+error_message+"<div style='position: relative;left: 30px;'><br>" +"</div>" + details,
								            	buttons: [{
								                	label: 'Close',
								                	cssClass: 'btn-danger',
								                	action: function(dialogItself){
								                    dialogItself.close();
								                	}
								            	}],
								            	onhidden: function(dialogRef){
								            		$('#submit_data').attr('disabled', false);
								            		Ladda.stopAll();	
							        			}
								        	});
									        /*BootstrapDialog.show({
								        		type: BootstrapDialog.TYPE_DANGER,
												title: 'Test Case Data Save Error', 
												message: xhr.status + ' : ' + thrownError + '\n\n' + xhr.responseText,
									            buttons: [{
									                label: 'Close',
									                cssClass: 'btn-danger',
									                action: function(dialogItself){
									                    dialogItself.close();
									                }
									            }],
									            onhidden: function(dialogRef){
									            	$('#submit_data').attr('disabled', false);
									            	Ladda.stopAll();
								        		}
									        });*/
						                }
							        });
								}
								else if (failFlowLength.length > 0) {
							        BootstrapDialog.show({
						        		type: BootstrapDialog.TYPE_DANGER,
										title: 'Flow Length Error!', 
										message: failFlowLength,
							            buttons: [{
							                label: 'Close',
							                cssClass: 'btn-danger',
							                action: function(dialogItself){
							                    dialogItself.close();
							                }
							            }],
							            onhidden: function(dialogRef){
							            	$('#submit_data').attr('disabled', false);
							            	Ladda.stopAll();
						        		}
							        });
								}
								else{
							        BootstrapDialog.show({
						        		type: BootstrapDialog.TYPE_DANGER,
										title: 'Required fields missing data!', 
										message: failFields + failFlowFields + failStepFields,
							            buttons: [{
							                label: 'Close',
							                cssClass: 'btn-danger',
							                action: function(dialogItself){
							                    dialogItself.close();
							                }
							            }],
							            onhidden: function(dialogRef){
							            	$('#submit_data').attr('disabled', false);
							            	Ladda.stopAll();
						        		}
							        });
								}	
							//} else {
								// Error message: Solo Case exists for App; return the Solo Case / App combo
						   //      BootstrapDialog.show({
					    //     		type: BootstrapDialog.TYPE_DANGER,
									// title: 'Solo Case Name already exists for this Product!', 
									// message: result2 + "\n\n Please choose another name for this case.",
						   //          buttons: [{
						   //              label: 'Close',
						   //              cssClass: 'btn-danger',
						   //              action: function(dialogItself){
						   //                  dialogItself.close();
						   //              }
						   //          }],
						   //          onhidden: function(dialogRef){
						   //          	$('#submit_data').attr('disabled', false);
						   //          	Ladda.stopAll();
					    //     		}
						   //      });								
								//alert('Solo Name Error');
							//}
						//})
					// } else {
					// 	// Error message: Test case with this name already exists for this flow
				 //        BootstrapDialog.show({
			  //       		type: BootstrapDialog.TYPE_DANGER,
					// 		title: 'Test Case with this name already exists for this Flow!', 
					// 		message: "Please choose another name for this Test Case.",
				 //            buttons: [{
				 //                label: 'Close',
				 //                cssClass: 'btn-danger',
				 //                action: function(dialogItself){
				 //                    dialogItself.close();
				 //                }
				 //            }],
				 //            onhidden: function(dialogRef){
				 //            	$('#submit_data').attr('disabled', false);
				 //            	Ladda.stopAll();
			  //       		}
				 //        });							
						//alert('Test Case/ Flow Error');
					//}
				//})	
			});

            // bound the 'checkAllProduct' checkbox, select all of checkbox on 'flows' table     
 			$('#checkAllProduct').click(function(){
	   			var dataTable = $('#flows').dataTable();
	   			// console.log(dataTable);
   				// console.log($(this).prop("checked"));
   				var checked = $(this).prop("checked");
    			$(dataTable.fnGetNodes()).find("td").each(function(){
        			$(this).find('input').prop("checked",checked);  // --- Joseph
   				});
      	 	}); 	
	
	        // bound the 'CheckAllEdit' checkbox, select all of checkbox on 'steps'  table
      	 	$('#checkAllEdit').click(function(){
	   			var dataTable = $('#steps').dataTable();
	   			// console.log(dataTable);
   				// console.log($(this).prop("checked"));
   				var checked = $(this).prop("checked");
    			$(dataTable.fnGetNodes()).find("td").each(function(){
        			$(this).find('input').prop("checked",checked);  // --- Joseph
   				});
      	 	}); 

		})
		
		function confirmDeleteFlows(data){
			var row;
			var tabFlows = $('#flows').dataTable();
			var tabSteps = $('#steps').dataTable();

			BootstrapDialog.show({
                type: BootstrapDialog.TYPE_DANGER,
                title: 'Confirm Flow Modification!',
                message: 'Removing elements of this flow will require removal of the linked steps.\n\nDo you want to continue?',
                buttons: [{
                    label: 'Yes',
                    cssClass: 'btn-danger',
                    action: function(dialogItself) {
                        dialogItself.close();

						// Delete all current rows
						tabFlows.fnClearTable();

                        // Remove all steps
                        tabSteps.fnClearTable();

				    	// Loop and create rows
				        $.each(data,function(i, item){
							$('#addFlowRow').trigger('click');

							// alert(item.app_id);

							// Look up the app id in the app table to get the data
							$.getJSON("/getapp/"+item.app_id,function(dataA){
								//alert(dataA[0].app_name);
								//.find('#app_id');

						        var arrN = tabFlows.fnGetNodes();
						        var lastRow = arrN[i];

								// Enter the product info
								$(lastRow).find('td').eq(3).html(dataA[0].project_id + " - " + dataA[0].app_name + "<button type='button' id='search_product' class='btn btn-info btn-xs pull-right' style='margin:2px;'>Search</button>");
								// Enter the app id
								$(lastRow).find('td').eq(10).text(dataA[0].id);

								// Enable the Add button
								$(lastRow).find('td').eq(9).find('#addStepRow').removeClass('disabled');
							})
				        }); 

				        // Close the dialog
				        $('#clear_flow').trigger('click');

                    }
                }, {
                    label: 'No',
                    cssClass: 'btn-danger',
                    action: function(dialogItself){
                        dialogItself.close();
                    }
                }]
            });
		}			
	
		function getTestCaseID(tc_id){
			var json = {tc_id:[]};
			var data = new Object;
			data['id'] = tc_id;
			json.tc_id.push(data);
			return json
		}

		function getHeaderData(tname){
			var json = {header_data:[]};
			var data = new Object;
			data['t_name'] = $('#test_case_name').val();
			data['t_product'] = $('#project_name').val();
			data['t_ppmid'] = $('#ppm_id').val();
			// data['t_portfolio'] = $('#portfolio').val();
			data['t_owner'] = $('#owner').val();
			data['t_hyperlink'] = $('#hyperlink').val();
			data['t_tctype'] = $('input:radio[name=test_case_type]:checked').val();
			data['t_exectype'] = $('input:radio[name=exec_type]:checked').val();
			json.header_data.push(data);
			return json
		}

		function getDetailData(tname, saving){
			var json = {detail_data:[]};

	        var dataTable = $('#flows').dataTable();

	        $(dataTable.fnGetNodes()).each(function(){
				var data = new Object;
				$(this).find("td").each(function(i){
					if ($(this).text() && $(this).text() != 'No data available in table'){
						id = $(this).attr('id');
						data[id] = $(this).text();

						// if (i > 3 && i < 9) { data[id] = formatCellData($(this).html()); } else { data[id] = $(this).text(); }

						// Get rid of junk data in product because of the search button
						if (id == 'product'){ data[id] = removeProductJunkData(data[id]); }

						// Replace <br> with \n for correct saving to the Database
						if (saving == true) {
							if (id == 'portfolio'){ data[id] = br2nl($(this).html()); }
							if (id == 'env'){ data[id] = br2nl($(this).html()); }
							if (id == 'biz_proc'){ data[id] = br2nl($(this).html()); }
							if (id == 'cov_type'){ data[id] = br2nl($(this).html()); }
							if (id == 'com_code'){ data[id] = br2nl($(this).html()); }
						}						
						
					}
				});
				json.detail_data.push(data)
			});
			return json;
		}

		function getStepData(tname, saving){
			var json = {step_data:[]};

	        var dataTable = $('#steps').dataTable();

	        $(dataTable.fnGetNodes()).each(function(){
				var data = new Object;
				$(this).find("td").each(function(i){
					//console.log($(this).find('input').val())
					if ($(this).text() && $(this).text() != 'No data available in table'){
						id = $(this).attr('id');
						data[id] = $(this).text();

						// Replace <br> with \n for correct saving to the Database
						if (saving == true) {
							if (id == 'proc_name'){ data[id] = br2nl($(this).html()); }
							if (id == 'step_desc'){ data[id] = br2nl($(this).html()); }
							if (id == 'data_input'){ data[id] = br2nl($(this).html()); }
							if (id == 'expec_res'){ data[id] = br2nl($(this).html()); }								
						}
					
					}
				});
				json.step_data.push(data)
	        });

			return json;
		}

		function br2nl(str) {
			//console.log(str);
			str = str.replace(/<\s*span.*?>/g,'');
			// console.log(str);
			str = str.replace(/<\/span>/g,'');
			// console.log(str);
			str = str.replace(/<\s*div.*?>/g,'');	
			// console.log(str);
			str = str.replace(/<\/div>/g,"\n");
			// console.log(str);
			str = str.replace(/<br.*?\/?>/mg,"\n");
			// console.log(str);
			if (str[str.length - 1] == "\n") { str = str.trim(); }
			// console.log(str);
		    return str;
		}

		function formatCellData(data) {
			// alert(data);
			// data = data.replace(/<br><\/div>/g,'<br>');
			// data = data.replace(/<\/div>/g,'<br>');
			// data = data.replace(/<\/span>/g,'');
			// data = data.replace(/<div.*contenteditable="">/g,'');	
			// data = data.replace(/<span.*">/g,'');
			// alert(data);
			return data;
		}
		
		function removeProductJunkData(productRaw){
			productRaw = productRaw.trim();
			productRaw = productRaw.substr(0,productRaw.length-6); 
			productRaw = productRaw.trim();

			return productRaw;
		}

        
        /* 
        * if the page has changed, will pop up the confirm window,otherwise not.
        * Author:Sara
        */
		function confirmCancel(from){
			// if page hasn't been changed, confirm window doesn't pop up
			if (!checkValueChange()) {
				if (from == 'cancel') {
					return;
				}
				window.location.assign('/main');
				return;
			}

	        BootstrapDialog.show({
	        	type: BootstrapDialog.TYPE_WARNING,
	            title: 'Confirm Cancel',
	            message: 'Do you want to exit without saving?',
	            buttons: [{
	                label: 'Yes',
	               	cssClass: 'btn-warning',
	                action: function(dialogItself) {
	                    dialogItself.close();
	                    window.location.assign('/main');
	                }
	            }, {
	                label: 'No',
	                cssClass: 'btn-warning',
	                action: function(dialogItself){
	                    dialogItself.close();
	                }
	            }]
	        });
		}

		/*
	   	 *  Check the created Case, if have any values change will return true,otherwise return false.
	   	 *  Author: Sara
	   	 */
		function checkValueChange() {
			var test_case_name=$('#test_case_name').val().trim();
			var project_name=$('#project_name').val().trim();
			var ppm_id=$('#ppm_id').val().trim();
			var owner=$('#owner').val().trim();
			var hyperlink=$('#hyperlink').val().trim();	
			var t_tctype = $('input:radio[name=test_case_type]:checked').val().trim();
			var t_exectype = $('input:radio[name=exec_type]:checked').val().trim();


			if (test_case_name != $('#test_case_name').attr('old-value').trim()) {
				return true;
			}

			if (project_name!=$('#project_name').attr('old-value').trim()) {
				return true;
			}

			if (ppm_id!=$('#ppm_id').attr('old-value').trim()){
				return true;
			}

			if (owner!=$('#owner').attr('old-value').trim()){
				return true;
			}

			if (hyperlink!=$('#hyperlink').attr('old-value').trim()){
				return true;
			}

			if (t_tctype != $('#old_test_case_type').val()) {
				return true;
			}

			if (t_exectype != $('#old_exec_type').val()) {
				return true;
			}

			// get data table current data. 
			var testHeader = getHeaderData("#header");
			var testDetail = getDetailData("#flows", false);
			var testSteps = getStepData("#steps", false);

			/* compare original data with current data ,if any data has been changed, will return true, means the
			* data table value has been changed.
			*/
			if (testDetail['detail_data'].length == gTestDetail['detail_data'].length) {
				var gDetail = gTestDetail['detail_data'];
				var detail = testDetail['detail_data'];
				var len = detail.length;
				for (var i = 0; i < len; i++) {
					if (gDetail[i]['add_step'] != detail[i]['add_step']) return true;
					if (gDetail[i]['app_id'] != detail[i]['app_id']) return true;
					if (gDetail[i]['biz_proc'] != detail[i]['biz_proc']) return true;
					if (gDetail[i]['com_code'] != detail[i]['com_code']) return true;
					if (gDetail[i]['cov_type'] != detail[i]['cov_type']) return true;
					if (gDetail[i]['env'] != detail[i]['env']) return true;
					if (gDetail[i]['portfolio'] != detail[i]['portfolio']) return true;
					if (gDetail[i]['product'] != detail[i]['product']) return true;
					if (gDetail[i]['seq_id'] != detail[i]['seq_id']) return true;
				}
			} else {
				return true;
			}

			if (testSteps['step_data'].length == gTestSteps['step_data'].length) {
				var gStep = gTestSteps['step_data'];
				var step = testSteps['step_data'];
				var len = step.length;
				for (var i = 0; i < len; i++) {
					if (gStep[i]['app_id'] != step[i]['app_id']) return true;
					if (gStep[i]['case_name'] != step[i]['case_name']) return true;
					if (gStep[i]['data_input'] != step[i]['data_input']) return true;
					if (gStep[i]['expec_res'] != step[i]['expec_res']) return true;
					if (gStep[i]['product'] != step[i]['product']) return true;
					if (gStep[i]['seq_id'] != step[i]['seq_id']) return true;
					if (gStep[i]['step_desc'] != step[i]['step_desc']) return true;
					if (gStep[i]['step_id'] != step[i]['step_id']) return true;
				}
			} else {
				return true;
			}

			return false;
		}

		function flowSearch() {
			$('#flowModal').modal('toggle');
		}

		function searchFlow(x){
		    var value=document.getElementById(x).value
		    if (value==""){
		        url = "/viewallflow"
		    }else
		    {
		        url = "/submitDialogFlow/flow_name=" + value
		    }
		    $.getJSON(url,function(data){
		        $("#infoFlow").html("");
		        $.each(data,function(i, item){
		            $("#infoFlow").append(
		                '<li class="list-group-item" id="' +item.id + ':' + item.flow_name + '" >' + item.flow_name +'</li>');  
		        })
		    })

		} 	

	</script>

	<body>
		<header class="navbar navbar-default navbar-static-top" style="height:58px; border-color: #e7e7e7;border-bottom: 1px solid transparent;">
			<div class="container" style="padding-left: 0px;">
				<img src="/img/HP-Log/HP_Blue_RGB_150_MN.png" class="img-responsive pull-left" alt="Responsive image">
				<a href="/main#" class="navbar-brand" style="padding-top:15px;">E2E Testing Library</a>
			<button class="navbar-toggle" data-toggle="collapse" data-target=".navHeaderCollapse">
				<span class="icon-bar"></span>
				<span class="icon-bar"></span>
				<span class="icon-bar"></span>
			</button>
				<div class="collapse navbar-collapse navHeaderCollapse">
					<div class="btn-group pull-right" style="top: 15px; left: 15px;">
					  <button type="button" class="btn btn-sm btn-default dropdown-toggle" data-toggle="dropdown" aria-expanded="false" style="background: white; border-color: #dddddd;"><i class="glyphicon glyphicon-user" style="color: grey;"></i>
					    <span style="padding-right: 10px; padding-left: 5px; color: grey;">john.doe@hp.com (Admin)</span><span class="caret" style="border-width: 4px 4px;"></span>
					  </button>
					  <ul class="dropdown-menu" role="menu" style="margin-top: 2px;">
					    <li><a href="/dashboard_flows_proj">Admin Dashboard</a></li>
					    <li class="divider"></li>
					    <li><a href="#">Log Out</a></li>
					  </ul>
					</div>
				</div>
			</div>
		</header>

		<div class="container col-xs-12 col-md-12">
			<div class="row">
				<div class="panel panel-default">
					<div class="panel-body col-md-12" style="height:75px;">
						<div class='col-md-6 col-xs-6'>
							<class="panel-title" style="font-size: 240%; font-weight: bold;"/>Edit Test Case
						</div>
						<%@testcase.each do |items|%>					
						<div class="container">
					        <div class="col-sm-3 col-xs-3 pull-right">    
					          <div class="panel panel-default">
					            <div class="panel-heading">
					              <h3 class="panel-title" style="margin-top:0px;">Flow ID:
					              	<label class="pull-right">
					              		<%if @testcasedetails.count > 0%>
					              			<%=items.flow_id%>
					              		<%else%>
					              			<%= ''%>
					              		<%end%>
					              	</label>
					              </h3>
					            </div>
					          </div>
							</div>
							<div class="col-sm-3 col-xs-3 pull-right">
					          <div class="panel panel-default">
					            <div class="panel-heading">
					              <h3 class="panel-title" style="margin-top:0px;">Test Case ID: <label class="pull-right"> <%= items.id %> </label></h3>
					            </div>
					          </div>
					        </div>    
						</div>
					</div>
				</div>
				<div class="custompanel custompanel-body custompanel-default">
					<form name="myform" method="post">
						<table id="header">  					
							<div class="container col-md-12">
				   	 		  <div class="form-group">
							    <label class="control-label"><h6><strong>Test Case Header:</strong></h6></label>
							    <label class="control-label pull-right"><h8><font color="red"><b>*</b> Required Fields</h8></font></label>
							  </div>
							</div>     
						</table>

						<div class="container col-md-12">
			   	 		  <div class="form-group">
						    <label class="col-md-3 col-xs-3 control-label" style="font-size:large;top: 5px;">Test Case Name* :</label>
						    <div class="col-md-6 col-xs-6">
						      <input type="text" class="form-control" name="test_case_name" id="test_case_name" placeholder="Input the Test Case Name.." onkeydown="return nameFieldRules(event, '#tcname_warning',this.value)" maxlength="64" value="<%=items.test_case_name%>" old-value="<%=items.test_case_name%>" />
						    </div>
						    <span class="label label-warning" id='tcname_warning' style='visibility:hidden'>Illegal Key: Only Alphanumeric and "_" "-"" allowed.</span>
						  </div>
						</div>
						<br>

						<div class="container col-md-12">
			   	 		  <div class="form-group">
						    <label class="col-md-3 col-xs-3 control-label" style="font-size:large;top: 5px;">Project Name* :</label>
						    <div class="col-md-6 col-xs-6">
						        <input type="text" class="form-control col-md-2" name="project_name" id="project_name" placeholder="Input the Project Name.." maxlength="256" value="<%=items.project%>" old-value="<%=items.project%>"/>
						    </div>
						    <span class="label label-warning" id='project_warning' style='visibility:hidden'></span>
						    <!-- <button type="button" class="col-md-3 btn btn-info pull-left" style="margin-top:0px;">Search</button> -->

						    <!-- <button class="btn btn-info btn-lg pull-left" data-toggle="modal" data-target="#myModal" style="margin-top:0px;">Search</button> -->

							<!-- Modal -->
							<div class="modal fade" id="myModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
							  <div class="modal-dialog">
							    <div class="modal-content">
							    	<div class="modal-header">
							        	<button type="button" id='close_modal' class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
							        	<h4 class="modal-title" id="myModalLabel">Product Search</h4>
							    	</div>
							    	<div class="modal-body">
										<div class="container">
											<div class="col-xs-10 col-md-12 sidebar-offcanvas" id="sidebar" role="navigation">
												<form id="submitForm" name="myform" method="post">
												<div class="form-group">
										   		<input type="text" name="searchcondition" class="form-control search-field" value placeholder="Search App.." id="searchbox" oninput="searchApp(this.id)"/>
										  		</div>
										  		</form>
										          <div class="list-group" id ="info">
										          	<%@apps.each do |items|%>
										            	<li class="list-group-item" id="<%=items.id%>:<%=items.project_id%> - <%=items.app_name%>"><%=items.project_id%> - <%=items.app_name%></li>
										            <%end%>
										          </div>
										    </div>       
	    								</div>
							      </div>
							      <div class="col-md-12 modal-footer">
							        <button type="button" id="clear_product" class="col-md-2 btn btn-primary pull-right" data-dismiss="modal" style="margin-left:5px;">Cancel</button>
							        <button type="button" id="select_product" class="col-md-2 btn btn-primary pull-right" data-dismiss="modal">Select</button>
							      </div>
							    </div>
							  </div>
							</div>
						  </div>
						</div>
						<br>

						<div class="container col-md-12">
			   	 		  <div class="form-group">
						    <label class="col-md-3 col-xs-3 control-label" style="font-size:large;top: 5px;">PPM ID* :</label>
						    <div class="col-md-6 col-xs-6">
						      <input type="text" class="form-control" name="ppm_id" id="ppm_id" placeholder="Input the PPM ID.." onkeydown="return isNumberKey(event, '#ppm_warning',this.value)" maxlength="6" value="<%=items.ppm_id%>" old-value="<%=items.ppm_id%>"/>
						    </div>
						    <span class="label label-warning" id='ppm_warning' style='visibility:hidden'>Only numeric input accepted.</span>
						  </div>
						</div>
						<br>

						<div class="container col-md-12">
			   	 		  <div class="form-group">
						    <label class="col-md-3 col-xs-3 control-label" style="font-size:large;top: 5px;">Owner* :</label>
						    <div class="col-md-6 col-xs-6">
						      <input type="text" class="form-control" name="owner" id="owner" placeholder="Input the Team Owner or Individual Owner.." maxlength="32" value="<%=items.owner%>" old-value="<%=items.owner%>"/>
						    </div>
						    <span class="label label-warning" id='owner_warning' style='visibility:hidden'></span>
						  </div>
						</div>
						<br>

						<div class="container col-md-12">
			   	 		  <div class="form-group">
						    <label class="col-md-3 col-xs-3 control-label" style="font-size:large;top: 5px;">Hyperlink :</label>
						    <div class="col-md-6 col-xs-6">
						      <input type="text" class="form-control" name="hyperlink" id="hyperlink" placeholder="Input the Hyperlink.." maxlength="1024" value="<%=items.hyperlink%>" old-value="<%=items.hyperlink%>"/>
						    </div>
						    <span class="label label-warning" id='link_warning' style='visibility:hidden'></span>
						  </div>
						</div>
						<br>

						<div class="container col-md-12">
			   	 		  <div class="form-group">
						    <label class="col-md-3 control-label" style="font-size:large;top: 5px;">Test Case Type* :</label>
						    <div class="col-md-6">
						      <input type="hidden" id="old_exec_type" value="<%=items.exec_type%>"/>
						  	  <input type="radio" name="exec_type" value="Functional"/>
						      <label for="exec_type">Functional</label>
						      <input type="radio" name="exec_type" value="Regression" />
						      <label for="exec_type">Regression</label>
						    </div>
						  </div>
						</div>

						<div class="container col-md-12">
			   	 		  <div class="form-group">
						    <label class="col-md-3 control-label" style="font-size:large;top: 5px;">Execution Type* :</label>
						    <div class="col-md-6">
						      <input type="hidden" id="old_test_case_type" value="<%=items.test_case_type%>"/>
						      <input type="radio" name="test_case_type" value="Manual"/>
						      <label for="testcasetype">Manual</label>
						      <input type="radio" name="test_case_type" value="Automation"/>
						      <label for="testcasetype">Automation</label>
						      <input type="radio" name="test_case_type" value="Both"/>
						      <label for="testcasetype">Both</label>					      
						    </div>
						  </div>
						</div>
						</table>
						<br>
						<%end%>	

						<br>
						<div>
							<div class="container col-md-12">
				   	 		  <div class="form-group" style="height:30px;">
							    <label class="control-label"><h6><strong>Test Case Application Flow:</strong></h6></label>
								<div class="modal fade" id="flowModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
									<div class="modal-dialog">
										<div class="modal-content">
											<div class="modal-header">
										    	<button type="button" id='close_modal' class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
										    	<h4 class="modal-title" id="myModalLabel">Flow Search</h4>
											</div>
											<div class="modal-body">
												<div class="container">
													<div class="col-xs-10 col-md-12 sidebar-offcanvas" id="sidebar" role="navigation">
														<form id="submitForm" name="myform" method="post">
															<div class="form-group">
													   			<input type="text" name="searchcondition" class="form-control search-field" value placeholder="Search Flow.." id="searchboxFlow" oninput="searchFlow(this.id)"/>
													  		</div>
												  		</form>
														<div class="list-group" id ="infoFlow">
															<%@flows.each do |items|%>
																<li class="list-group-item" id="<%=items.id%>:<%=items.flow_name%>"><%=items.flow_name%></li>
															<%end%>
														</div>
												    </div>       
												</div>
										  </div>
										  <div class="col-md-12 modal-footer">
										    <button type="button" id="clear_flow" class="col-md-2 btn btn-primary pull-right" data-dismiss="modal" style="margin-left:5px;">Cancel</button>
										    <button type="button" id="select_flow" class="col-md-2 btn btn-primary pull-right" data-dismiss="modal">Select</button>
										  </div>
										</div>
									</div>
								</div>

							</div>
							<table width="98%" aria-describedby="flows" role="grid" class="table table-striped table-bordered dataTable no-footer" style="table-layout:fixed;" id="flows" cellpadding="0" cellspacing="0" border="0">
							    <span class="btn-group pull-right" >
							    	<button type="button" id='flowSearch' class="col-md-3 btn btn-sm btn-primary pull-left" style="width:150px; margin-top:2px; margin-right:2px; cursor:pointer;" onclick=flowSearch()>Existing Flow Search</button>
							    	<button type="button" id='addFlowRow' class="col-md-3 btn btn-sm btn-info" style="width:75px; margin-top:10px; margin:2px; cursor:pointer;">Add</button>
								    <button type="button" id='deleteFlowRow' class="col-md-3 btn btn-sm btn-info" style="width:75px; margin-top:10px; margin: 2px; cursor:pointer;">Delete</button>
							    </span>						
								<thead>
									<tr>
										<th style='vertical-align:middle;text-align:center;'>
											<!-- add a input tag for check all checkbox on #flows table  -->
											<input type="checkbox" id="checkAllProduct" colspan="1" rowspan="1" aria-controls="flows" tabindex="0" style="position: relative; left: -6px;" />
										</th>
										<th id="flow_id" style="display:none;">ID</th>
										<th aria-label="Sequence ID" colspan="1" rowspan="1" aria-controls="flows" tabindex="0">Seq. ID</th>
										<th aria-label="Product" colspan="1" rowspan="1" aria-controls="flows" tabindex="0">Product *</th>
										<th aria-label="Portfolio" aria-sort="ascending" colspan="1" rowspan="1" aria-controls="flows" tabindex="0">Portfolio</th>
										<th aria-label="Environment Box" aria-sort="ascending" colspan="1" rowspan="1" aria-controls="flows" tabindex="0">Env. Box</th>
										<th aria-label="Biz Process/Main Function Tested" aria-sort="ascending" colspan="1" rowspan="1" aria-controls="flows" tabindex="0">Data Input/T-Code</th>
										<th aria-label="Key Doc Type" aria-sort="ascending" colspan="1" rowspan="1" aria-controls="flows" tabindex="0">Key Doc Type</th>
										<th aria-label="Company Code" aria-sort="ascending" colspan="1" rowspan="1" aria-controls="flows" tabindex="0">Co. Code</th>
										<th aria-label="Steps" colspan="1" rowspan="1" aria-controls="flows" tabindex="0">Steps</th>
										<th aria-sort="ascending" style="display:none;" colspan="1" rowspan="1" aria-controls="flows" tabindex="0">App ID</th>
									</tr>
								</thead>
								<tbody style="font-size:80%;">
									<%@testcasedetails.each do |items|%>
									<tr>
										<td style='vertical-align:middle;text-align:center;'><input type='checkbox'></td>
										<td id="id" style="display:none;"><%=items.id%></td>
										<td id='seq_id' style='vertical-align:middle; text-align:center;'><%=items.sequence_id%></td>
										<td id='product' style='line-height: 30px;vertical-align:middle;'>
											<%=items.project_id%>
											<button type='button' class='btn btn-info btn-xs pull-right' style='margin-right:1px;' id='search_product'>Search</button>
										</td>
										<td id='portfolio' style='vertical-align:middle;' contenteditable><div style='word-break:break-word; word-wrap: break-word; vertical-align: middle;' contenteditable><%if items.portfolio != nil%><%=items.portfolio.gsub('<', '&lt').gsub('>', '&gt').gsub(/(?:\n\r?|\r\n?)/, '<br>')%><%else%><%=items.portfolio%><%end%></div></td>
										<td id='env' style='vertical-align:middle;' contenteditable><div style='word-break:break-word; word-wrap: break-word; vertical-align: middle;' contenteditable><%if items.environment_box != nil%><%=items.environment_box.gsub('<', '&lt').gsub('>', '&gt').gsub(/(?:\n\r?|\r\n?)/, '<br>')%><%else%><%=items.environment_box%><%end%></div></td>		
										<td id='biz_proc' style='vertical-align:middle;' contenteditable><div style='word-break:break-word; word-wrap: break-word; vertical-align: middle;' contenteditable><%if items.business_process != nil%><%=items.business_process.gsub('<', '&lt').gsub('>', '&gt').gsub(/(?:\n\r?|\r\n?)/, '<br>')%><%else%><%=items.business_process%><%end%></div></td>
										<td id='cov_type' style='vertical-align:middle;' contenteditable><div style='word-break:break-word; word-wrap: break-word; vertical-align: middle;' contenteditable><%if items.covered_type != nil%><%=items.covered_type.gsub('<', '&lt').gsub('>', '&gt').gsub(/(?:\n\r?|\r\n?)/, '<br>')%><%else%><%=items.covered_type%><%end%></div></td>
										<td id='com_code' style='vertical-align:middle;' contenteditable><div style='word-break:break-word; word-wrap: break-word; vertical-align: middle;' contenteditable><%if items.company_code != nil%><%=items.company_code.gsub('<', '&lt').gsub('>', '&gt').gsub(/(?:\n\r?|\r\n?)/, '<br>')%><%else%><%=items.company_code%><%end%></div></td>
										<td id='add_step' style='text-align:center;vertical-align:middle;'><button type='button' id='addStepRow' class='btn btn-info btn-xs' style='margin:2px;'>Add</button></td>
										<td id='app_id' style="display:none;"><%=items.app_id%></td>
									</tr>
							 		<%end%>								
								</tbody>
							</table>
						</div>
						<br><br>

						<div>
							<div class="container col-md-12">
				   	 		  <div class="form-group" style="height:30px;">
							    <label class="control-label"><h6><strong>Solo Case Steps:</strong></h6></label>
							</div>
							<table width="98%" aria-describedby="steps" role="grid" class="table table-bordered dataTable no-footer" style="table-layout:fixed;" id="steps" cellpadding="0" cellspacing="0" border="0">
							    <span class="btn-group pull-right">
								    <button type="button" id="deleteStepRow" class="col-md-3 btn btn-sm btn-info" style="width:75px; margin-top:10px; margin: 2px; cursor:pointer;">Delete</button>
							    </span>						
								<thead>

									<tr> 
										<th style='vertical-align:middle;text-align:center;'>
											<!-- add a input tag for check all checkbox on #steps table  -->
											<input type="checkbox" id="checkAllEdit" colspan="1" rowspan="1" aria-controls="flows" tabindex="0" style="position: relative; left: -6px;"/>
										</th>
										<th style="display:none;">ID</th>
										<th style="display:none;">Seq ID</th>
										<th aria-label="Product" id="product_head" colspan="1" rowspan="1" aria-controls="flows" tabindex="0">Product</th>
										<th aria-label="Case Name" colspan="1" rowspan="1" aria-controls="flows" tabindex="0">Case Name *</th>
										<th aria-label="Step ID" colspan="1" rowspan="1" aria-controls="flows" tabindex="0">Step #</th>
										<th aria-label="Step Description" colspan="1" rowspan="1" aria-controls="flows" tabindex="0" >Process Name</th>
										<th aria-label="Step Description" colspan="1" rowspan="1" aria-controls="flows" tabindex="0" >Step Description *</th>
										<th aria-label="Data Input" colspan="1" rowspan="1" aria-controls="flows" tabindex="0">Data Input</th>
										<th aria-label="Expected Result" colspan="1" rowspan="1" aria-controls="flows" tabindex="0">Expected Result</th>
										<th aria-label="Memo" style="display:none;" colspan="1" rowspan="1" aria-controls="flows" tabindex="0">Memo</th>
										<th aria-label="App ID" style="display:none;" colspan="1" rowspan="1" aria-controls="flows" tabindex="0">App ID</th>	
									</tr>
								</thead>
								<tbody style="font-size:80%;">
									<%@solo_case_steps.each do |items|%>
										<!-- Highlight the first row of a Solo Test Case to make it easier for a user to see -->
										<%if items.step_id == 1%>
											<!-- <tr style="font-weight: bold"> -->
											<!-- <tr style="background-color:#F2F2FF;"> -->
											<tr style="background-color:#F0F2FF; font-weight: bold;">
										<%else%>
											<tr>
										<%end%>
										
										<td style='vertical-align:middle;text-align:center;'><input type='checkbox'></td>
										<td id="id" style="display:none;"><%=items.id%></td>
										<td id="seq_id" style="display:none;"><%=items.sequence_id%></td>
										<td id='product' style='vertical-align:middle;'><%=items.project_id%> - <%=items.app_name%></td>
										<td id='case_name' style='vertical-align:middle;' contenteditable><div style='word-break:break-word; word-wrap: break-word; vertical-align: middle;' contenteditable><%=items.solo_case_name%></div></td>
										<td id='step_id' style='vertical-align:middle; text-align:center;'><%=items.step_id%></td>
										<td id='proc_name' style='vertical-align:middle;' contenteditable><div style='word-break:break-word; word-wrap: break-word; vertical-align: middle;' contenteditable><%if items.process_name != nil%><%=items.process_name.gsub('<', '&lt').gsub('>', '&gt').gsub(/(?:\n\r?|\r\n?)/, '<br>')%><%else%><%=items.process_name%><%end%></div></td>
										<td id='step_desc' style='vertical-align:middle;' contenteditable><div style='word-break:break-word; word-wrap: break-word; vertical-align: middle;' contenteditable><%if items.step_description != nil%><%=items.step_description.gsub('<', '&lt').gsub('>', '&gt').gsub(/(?:\n\r?|\r\n?)/, '<br>')%><%else%><%=items.step_description%><%end%></div></td>
										<td id='data_input' style='vertical-align:middle;' contenteditable><div style='word-break:break-word; word-wrap: break-word; vertical-align: middle;' contenteditable><%if items.data_input != nil%><%=items.data_input.gsub('<', '&lt').gsub('>', '&gt').gsub(/(?:\n\r?|\r\n?)/, '<br>')%><%else%><%=items.data_input%><%end%></div></td>
										<td id='expec_res' style='vertical-align:middle;' contenteditable><div style='word-break:break-word; word-wrap: break-word; vertical-align: middle;' contenteditable><%if items.expected_result != nil%><%=items.expected_result.gsub('<', '&lt').gsub('>', '&gt').gsub(/(?:\n\r?|\r\n?)/, '<br>')%><%else%><%=items.expected_result%><%end%></div></td>
										<td id='memo' style="display:none;"><%=items.memo%></td>
										<td id="app_id" style="display:none;"><%=items.app_id%></td>
										</tr>
									<%end%>		
								</tbody>
							</table>
						</div>
						<br>

						<div class="container pull-right">
							<tr>
								<td>
									<button type="button" class="btn btn-primary btn-lg ladda-button" data-style="zoom-in" id="submit_data" style="width:100px;" value="Save" onClick="this.disabled=true;"><span class="glyphicon glyphicon-floppy-disk"></span> Save</button>
								</td>
								<td>
									<button type="button" class="btn btn btn-warning btn-lg"  data-dismiss = "modal" style="width:110px;" onclick=confirmCancel()><span class="glyphicon glyphicon-ban-circle"></span> Cancel</button>
								</td>
							</tr>
						</div>
					</form>
				</div>
			</div>
		</div>

<!-- 		<footer class="navbar navbar-default navbar-fixed-bottom">
			<div class="container">
				<p class="navbar-text pull-right">Version 1.0</p>
			</div>
		</footer> -->
		<script>
			// Bind normal buttons
			Ladda.bind( '#submit_data');
		</script>
	</body>
</html>